<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>laue_dials.refine &#8212; laue-dials</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=0ca6144b" />
    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=6f5810c2"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="icon" href="../_static/rs-favicon_32x32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="laue_dials.predict" href="predict.html" />
    <link rel="prev" title="laue_dials.optimize_indexing" href="optimize_indexing.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="laue-dials-refine">
<span id="refine"></span><h1>laue_dials.refine<a class="headerlink" href="#laue-dials-refine" title="Link to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>This script handles polychromatic geometry refinement.</p>
<p>This program takes an indexed DIALS experiment list and reflection table
(with wavelengths) and refines the experiment geometry. The outputs are a pair of
files (poly_refined.expt, poly_refined.refl) that contain an experiment geometry
suitable for prediction and integration.</p>
<p>Examples:</p>
<blockquote>
<div><p>laue.refine [options] optimized.expt optimized.refl</p>
</div></blockquote>
</section>
<section id="basic-parameters">
<h2>Basic parameters<a class="headerlink" href="#basic-parameters" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="p">{</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">log</span> <span class="o">=</span> <span class="n">laue</span><span class="o">.</span><span class="n">poly_refined</span><span class="o">.</span><span class="n">log</span>
<span class="p">}</span>
<span class="n">n_static_macrocycles</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">separate_independent_sets</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">refinement</span> <span class="p">{</span>
  <span class="n">parameterisation</span> <span class="p">{</span>
    <span class="n">scan_varying</span> <span class="o">=</span> <span class="n">Auto</span>
    <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">set_scan_varying_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">beam</span> <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="o">*</span><span class="n">in_spindle_plane</span> <span class="o">*</span><span class="n">out_spindle_plane</span> <span class="n">wavelength</span>
    <span class="p">}</span>
    <span class="n">crystal</span> <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="n">cell</span> <span class="n">orientation</span>
    <span class="p">}</span>
    <span class="n">detector</span> <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="n">position</span> <span class="n">orientation</span> <span class="o">*</span><span class="n">distance</span>
    <span class="p">}</span>
    <span class="n">goniometer</span> <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="o">*</span><span class="nb">all</span> <span class="n">in_beam_plane</span> <span class="n">out_beam_plane</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">reflections</span> <span class="p">{</span>
    <span class="n">outlier</span> <span class="p">{</span>
      <span class="n">algorithm</span> <span class="o">=</span> <span class="n">null</span> <span class="n">auto</span> <span class="o">*</span><span class="n">mcd</span> <span class="n">tukey</span> <span class="n">sauter_poon</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">nproc</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="full-parameter-definitions">
<h2>Full parameter definitions<a class="headerlink" href="#full-parameter-definitions" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="p">{</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">expt</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for refined experimental models&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">refl</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for reflections with updated predictions&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
  <span class="n">include_unused_reflections</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If True, keep reflections unused in refinement in updated&quot;</span>
            <span class="s2">&quot;reflections file. Otherwise, remove them&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">matches</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for output of the reflection table for reflections&quot;</span>
            <span class="s2">&quot;used in refinement, containing extra columns used internally.&quot;</span>
            <span class="s2">&quot;Intended for debugging purposes only&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for the table of centroids at the end of refinement&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">parameter_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for the table of scan varying parameter values&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">log</span> <span class="o">=</span> <span class="n">laue</span><span class="o">.</span><span class="n">poly_refined</span><span class="o">.</span><span class="n">log</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
  <span class="n">correlation_plot</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">{</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The base filename for output of plots of parameter&quot;</span>
              <span class="s2">&quot;correlations. A file extension may be added to control the type&quot;</span>
              <span class="s2">&quot;of output file, if it is one of matplotlib&#39;s supported types. A&quot;</span>
              <span class="s2">&quot;JSON file with the same base filename will also be created,&quot;</span>
              <span class="s2">&quot;containing the correlation matrix and column labels for later&quot;</span>
              <span class="s2">&quot;inspection, replotting etc.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">col_select</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Specific columns to include in the plots of parameter&quot;</span>
              <span class="s2">&quot;correlations, either specified by parameter name or 0-based&quot;</span>
              <span class="s2">&quot;column index. Defaults to all columns. This option is useful&quot;</span>
              <span class="s2">&quot;when there is a large number of parameters&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Steps for which to make correlation plots. By default only the&quot;</span>
              <span class="s2">&quot;final step is plotted. Uses zero-based numbering, so the first&quot;</span>
              <span class="s2">&quot;step is numbered 0.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The filename for output of the refinement history json&quot;</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">n_static_macrocycles</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of macro-cycles of static refinement to perform&quot;</span>
  <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">separate_independent_sets</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If true, the experiment list will be separated into independent&quot;</span>
          <span class="s2">&quot;groups that do not share models, and these groups will be refined&quot;</span>
          <span class="s2">&quot;separately.&quot;</span>
  <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
<span class="n">refinement</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters to configure the refinement&quot;</span>
<span class="p">{</span>
  <span class="n">mp</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="p">{</span>
    <span class="n">nproc</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The number of processes to use. Not all choices of refinement&quot;</span>
              <span class="s2">&quot;engine support nproc &gt; 1. Where multiprocessing is possible, it&quot;</span>
              <span class="s2">&quot;is helpful only in certain circumstances, so this is not&quot;</span>
              <span class="s2">&quot;recommended for typical use.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">parameterisation</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters to control the parameterisation of experimental models&quot;</span>
  <span class="p">{</span>
    <span class="n">auto_reduction</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;determine behaviour when there are too few reflections to&quot;</span>
              <span class="s2">&quot;reasonably produce a full parameterisation of the experiment&quot;</span>
              <span class="s2">&quot;list&quot;</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">{</span>
      <span class="n">min_nref_per_parameter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;the smallest number of reflections per parameter for a model&quot;</span>
                <span class="s2">&quot;parameterisation below which the parameterisation will not be&quot;</span>
                <span class="s2">&quot;made in full, but the action described below will be&quot;</span>
                <span class="s2">&quot;triggered.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">action</span> <span class="o">=</span> <span class="n">fail</span> <span class="o">*</span><span class="n">fix</span> <span class="n">remove</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;action to take if there are too few reflections across the&quot;</span>
                <span class="s2">&quot;experiments related to a particular model parameterisation.&quot;</span>
                <span class="s2">&quot;If fail, an exception will be raised and refinement will not&quot;</span>
                <span class="s2">&quot;proceed. If fix, refinement will continue but with the&quot;</span>
                <span class="s2">&quot;parameters relating to that model remaining fixed at their&quot;</span>
                <span class="s2">&quot;initial values. If remove, parameters relating to that model&quot;</span>
                <span class="s2">&quot;will be fixed, and in addition all reflections related to&quot;</span>
                <span class="s2">&quot;that parameterisation will be removed. This will therefore&quot;</span>
                <span class="s2">&quot;remove these reflections from other parameterisations of the&quot;</span>
                <span class="s2">&quot;global model too. For example, if a crystal model could not&quot;</span>
                <span class="s2">&quot;be parameterised it will be excised completely and not&quot;</span>
                <span class="s2">&quot;contribute to the joint refinement of the detector and beam.&quot;</span>
                <span class="s2">&quot;In the fix mode, reflections emanating from that crystal will&quot;</span>
                <span class="s2">&quot;still form residuals and will contribute to detector and beam&quot;</span>
                <span class="s2">&quot;refinement.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
    <span class="p">}</span>
    <span class="n">scan_varying</span> <span class="o">=</span> <span class="n">Auto</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Allow models that are not forced to be static to vary during&quot;</span>
              <span class="s2">&quot;the scan, Auto will run one macrocycle with static then scan&quot;</span>
              <span class="s2">&quot;varying refinement for the crystal&quot;</span>
      <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Scan-varying refinement&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
    <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Overall default value of the width of scan between checkpoints&quot;</span>
              <span class="s2">&quot;in degrees for scan-varying refinement. If set to None, each&quot;</span>
              <span class="s2">&quot;model will use its own specified value.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">compose_model_per</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span><span class="n">block</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;For scan-varying parameterisations, compose a new model either&quot;</span>
              <span class="s2">&quot;every image or within blocks of a width specified in the&quot;</span>
              <span class="s2">&quot;reflections parameters. When this block width is larger than&quot;</span>
              <span class="s2">&quot;the image width the result is faster, with a trade-off in&quot;</span>
              <span class="s2">&quot;accuracy&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">block_width</span> <span class="o">=</span> <span class="mf">1.0</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of a reflection &#39;block&#39; (in degrees) determining how&quot;</span>
              <span class="s2">&quot;fine- grained the model used for scan-varying prediction during&quot;</span>
              <span class="s2">&quot;refinement is. Currently only has any effect if the crystal&quot;</span>
              <span class="s2">&quot;parameterisation is set to use compose_model_per=block&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">set_scan_varying_errors</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If scan-varying refinement is done, and if the estimated&quot;</span>
              <span class="s2">&quot;covariance of the model states have been calculated by the&quot;</span>
              <span class="s2">&quot;minimiser, choose whether to return this to the models or not.&quot;</span>
              <span class="s2">&quot;The default is not to, in order to keep the file size of the&quot;</span>
              <span class="s2">&quot;serialized model small. At the moment, this only has an effect&quot;</span>
              <span class="s2">&quot;for crystal unit cell (B matrix) errors.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
    <span class="n">trim_scan_to_observations</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;For scan-varying refinement, trim scan objects to the range of&quot;</span>
              <span class="s2">&quot;observed reflections. This avoids failures in refinement for&quot;</span>
              <span class="s2">&quot;cases where the extremes of scans contain no data, such as when&quot;</span>
              <span class="s2">&quot;the crystal moves out of the beam.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">debug_centroid_analysis</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Set True to write out a file containing the reflections used&quot;</span>
              <span class="s2">&quot;for centroid analysis for automatic setting of the &quot;</span>
              <span class="s2">&quot;scan-varying interval width. This can then be analysed with&quot;</span>
              <span class="s2">&quot;dev.dials.plot_centroid_analysis (requires dials_scratch&quot;</span>
              <span class="s2">&quot;repository).&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">beam</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;beam parameters&quot;</span>
    <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="o">*</span><span class="n">in_spindle_plane</span> <span class="o">*</span><span class="n">out_spindle_plane</span> <span class="n">wavelength</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Whether to fix beam parameters. By default, in_spindle_plane&quot;</span>
                <span class="s2">&quot;is selected, and one of the two parameters is fixed. If a&quot;</span>
                <span class="s2">&quot;goniometer is present this leads to the beam orientation&quot;</span>
                <span class="s2">&quot;being restricted to a direction in the initial spindle-beam&quot;</span>
                <span class="s2">&quot;plane. Wavelength is also fixed by default, to allow&quot;</span>
                <span class="s2">&quot;refinement of the unit cell volume.&quot;</span>
        <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Fix beam parameters&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">fix_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix specified parameters by a list of 0-based indices or&quot;</span>
                <span class="s2">&quot;partial names to match&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">constraints</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameter equal shift constraints to use in refinement.&quot;</span>
        <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="p">{</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up which&quot;</span>
                  <span class="s2">&quot;parameterisations to apply the constraint to. If an&quot;</span>
                  <span class="s2">&quot;identified parameterisation affects multiple experiments&quot;</span>
                  <span class="s2">&quot;then the index of any one of those experiments suffices to&quot;</span>
                  <span class="s2">&quot;identify that parameterisation. If None (the default) then&quot;</span>
                  <span class="s2">&quot;constraints will be applied to all parameterisations of&quot;</span>
                  <span class="s2">&quot;this type.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Identify which parameter of each parameterisation to&quot;</span>
                  <span class="s2">&quot;constrain by a (partial) parameter name to match. Model&quot;</span>
                  <span class="s2">&quot;name prefixes such as &#39;Detector1&#39; will be ignored as&quot;</span>
                  <span class="s2">&quot;parameterisations are already identified by experiment id&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
      <span class="p">}</span>
      <span class="n">force_static</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Force a static parameterisation for the beam when doing&quot;</span>
                <span class="s2">&quot;scan-varying refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">smoother</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options that affect scan-varying parameterisation&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="mf">36.0</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of scan between checkpoints in degrees. Can be set to&quot;</span>
                  <span class="s2">&quot;Auto.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">absolute_num_intervals</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of intervals between checkpoints if scan_varying&quot;</span>
                  <span class="s2">&quot;refinement is requested. If set, this overrides&quot;</span>
                  <span class="s2">&quot;interval_width_degrees&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">crystal</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;crystal parameters&quot;</span>
    <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="n">cell</span> <span class="n">orientation</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix crystal parameters&quot;</span>
        <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Fix crystal parameters&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
      <span class="n">unit_cell</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">fix_list</span> <span class="o">=</span> <span class="n">real_space_a</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix specified parameters by a list of 0-based indices or&quot;</span>
                  <span class="s2">&quot;partial names to match&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">restraints</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Least squares unit cell restraints to use in refinement.&quot;</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="p">{</span>
          <span class="n">tie_to_target</span>
            <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="p">{</span>
            <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Target unit cell parameters for the restraint for this&quot;</span>
                      <span class="s2">&quot;parameterisation&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">sigmas</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The unit cell target values are associated with sigmas&quot;</span>
                      <span class="s2">&quot;which are used to determine the weight of each&quot;</span>
                      <span class="s2">&quot;restraint. A sigma of zero will remove the restraint at&quot;</span>
                      <span class="s2">&quot;that position. If symmetry constrains two cell&quot;</span>
                      <span class="s2">&quot;dimensions to be equal then only the smaller of the two&quot;</span>
                      <span class="s2">&quot;sigmas will be kept&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up&quot;</span>
                      <span class="s2">&quot;which parameterisations to apply these restraints to.&quot;</span>
                      <span class="s2">&quot;If an identified parameterisation affects multiple&quot;</span>
                      <span class="s2">&quot;experiments then the index of any one of those&quot;</span>
                      <span class="s2">&quot;experiments suffices to restrain that parameterisation.&quot;</span>
                      <span class="s2">&quot;If None (the default) then the restraints will be&quot;</span>
                      <span class="s2">&quot;applied to all experiments.&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="p">}</span>
          <span class="n">tie_to_group</span>
            <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="p">{</span>
            <span class="n">target</span> <span class="o">=</span> <span class="o">*</span><span class="n">mean</span> <span class="n">low_memory_mean</span> <span class="n">median</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Function to tie group parameter values to&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
            <span class="n">sigmas</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The unit cell parameters are associated with sigmas&quot;</span>
                      <span class="s2">&quot;which are used to determine the weight of each&quot;</span>
                      <span class="s2">&quot;restraint. A sigma of zero will remove the restraint at&quot;</span>
                      <span class="s2">&quot;that position.&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up&quot;</span>
                      <span class="s2">&quot;which  parameterisations to apply these restraints to.&quot;</span>
                      <span class="s2">&quot;For every parameterisation that requires a restraint at&quot;</span>
                      <span class="s2">&quot;least one experiment index must be supplied. If None&quot;</span>
                      <span class="s2">&quot;(the default) the restraints will be applied to all&quot;</span>
                      <span class="s2">&quot;experiments.&quot;</span>
              <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">constraints</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameter equal shift constraints to use in refinement.&quot;</span>
          <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="p">{</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up&quot;</span>
                    <span class="s2">&quot;which parameterisations to apply the constraint to. If an&quot;</span>
                    <span class="s2">&quot;identified parameterisation affects multiple experiments&quot;</span>
                    <span class="s2">&quot;then the index of any one of those experiments suffices&quot;</span>
                    <span class="s2">&quot;to identify that parameterisation. If None (the default)&quot;</span>
                    <span class="s2">&quot;then constraints will be applied to all parameterisations&quot;</span>
                    <span class="s2">&quot;of this type.&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Identify which parameter of each parameterisation to&quot;</span>
                    <span class="s2">&quot;constrain by a (partial) parameter name to match. Model&quot;</span>
                    <span class="s2">&quot;name prefixes such as &#39;Detector1&#39; will be ignored as&quot;</span>
                    <span class="s2">&quot;parameterisations are already identified by experiment id&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="p">}</span>
        <span class="n">force_static</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Force a static parameterisation for the crystal unit cell&quot;</span>
                  <span class="s2">&quot;when doing scan-varying refinement&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">smoother</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options that affect scan-varying parameterisation&quot;</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="p">{</span>
          <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="mf">36.0</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of scan between checkpoints in degrees. Can be set&quot;</span>
                    <span class="s2">&quot;to Auto.&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">absolute_num_intervals</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of intervals between checkpoints if scan_varying&quot;</span>
                    <span class="s2">&quot;refinement is requested. If set, this overrides&quot;</span>
                    <span class="s2">&quot;interval_width_degrees&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">orientation</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">fix_list</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix specified parameters by a list of 0-based indices or&quot;</span>
                  <span class="s2">&quot;partial names to match&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">constraints</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameter equal shift constraints to use in refinement.&quot;</span>
          <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="p">{</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up&quot;</span>
                    <span class="s2">&quot;which parameterisations to apply the constraint to. If an&quot;</span>
                    <span class="s2">&quot;identified parameterisation affects multiple experiments&quot;</span>
                    <span class="s2">&quot;then the index of any one of those experiments suffices&quot;</span>
                    <span class="s2">&quot;to identify that parameterisation. If None (the default)&quot;</span>
                    <span class="s2">&quot;then constraints will be applied to all parameterisations&quot;</span>
                    <span class="s2">&quot;of this type.&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Identify which parameter of each parameterisation to&quot;</span>
                    <span class="s2">&quot;constrain by a (partial) parameter name to match. Model&quot;</span>
                    <span class="s2">&quot;name prefixes such as &#39;Detector1&#39; will be ignored as&quot;</span>
                    <span class="s2">&quot;parameterisations are already identified by experiment id&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="p">}</span>
        <span class="n">force_static</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Force a static parameterisation for the crystal orientation&quot;</span>
                  <span class="s2">&quot;when doing scan-varying refinement&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">smoother</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options that affect scan-varying parameterisation&quot;</span>
          <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="p">{</span>
          <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="mf">36.0</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of scan between checkpoints in degrees. Can be set&quot;</span>
                    <span class="s2">&quot;to Auto.&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">absolute_num_intervals</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of intervals between checkpoints if scan_varying&quot;</span>
                    <span class="s2">&quot;refinement is requested. If set, this overrides&quot;</span>
                    <span class="s2">&quot;interval_width_degrees&quot;</span>
            <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">detector</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;detector parameters&quot;</span>
    <span class="p">{</span>
      <span class="n">panels</span> <span class="o">=</span> <span class="o">*</span><span class="n">automatic</span> <span class="n">single</span> <span class="n">multiple</span> <span class="n">hierarchical</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select appropriate detector parameterisation. Both the single&quot;</span>
                <span class="s2">&quot;and multiple panel detector options treat the whole detector&quot;</span>
                <span class="s2">&quot;as a rigid body. The hierarchical parameterisation treats&quot;</span>
                <span class="s2">&quot;groups of panels as separate rigid bodies.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">hierarchy_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Level of the detector hierarchy (starting from the root at 0)&quot;</span>
                <span class="s2">&quot;at which to determine panel groups to parameterise&quot;</span>
                <span class="s2">&quot;independently&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="nb">all</span> <span class="n">position</span> <span class="n">orientation</span> <span class="o">*</span><span class="n">distance</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix detector parameters. The translational parameters&quot;</span>
                <span class="s2">&quot;(position) may be set separately to the orientation.&quot;</span>
        <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Fix detector parameters&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
      <span class="n">fix_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix specified parameters by a list of 0-based indices or&quot;</span>
                <span class="s2">&quot;partial names to match&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">constraints</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameter equal shift constraints to use in refinement.&quot;</span>
        <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="p">{</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up which&quot;</span>
                  <span class="s2">&quot;parameterisations to apply the constraint to. If an&quot;</span>
                  <span class="s2">&quot;identified parameterisation affects multiple experiments&quot;</span>
                  <span class="s2">&quot;then the index of any one of those experiments suffices to&quot;</span>
                  <span class="s2">&quot;identify that parameterisation. If None (the default) then&quot;</span>
                  <span class="s2">&quot;constraints will be applied to all parameterisations of&quot;</span>
                  <span class="s2">&quot;this type.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Identify which parameter of each parameterisation to&quot;</span>
                  <span class="s2">&quot;constrain by a (partial) parameter name to match. Model&quot;</span>
                  <span class="s2">&quot;name prefixes such as &#39;Detector1&#39; will be ignored as&quot;</span>
                  <span class="s2">&quot;parameterisations are already identified by experiment id&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
      <span class="p">}</span>
      <span class="n">force_static</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Force a static parameterisation for the detector when doing&quot;</span>
                <span class="s2">&quot;scan-varying refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">smoother</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options that affect scan-varying parameterisation&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="mf">36.0</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of scan between checkpoints in degrees. Can be set to&quot;</span>
                  <span class="s2">&quot;Auto.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">absolute_num_intervals</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of intervals between checkpoints if scan_varying&quot;</span>
                  <span class="s2">&quot;refinement is requested. If set, this overrides&quot;</span>
                  <span class="s2">&quot;interval_width_degrees&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">goniometer</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;goniometer setting matrix parameters&quot;</span>
    <span class="p">{</span>
      <span class="n">fix</span> <span class="o">=</span> <span class="o">*</span><span class="nb">all</span> <span class="n">in_beam_plane</span> <span class="n">out_beam_plane</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Whether to fix goniometer parameters. By default, fix all.&quot;</span>
                <span class="s2">&quot;Alternatively the setting matrix can be constrained to allow&quot;</span>
                <span class="s2">&quot;rotation only within the spindle-beam plane or to allow&quot;</span>
                <span class="s2">&quot;rotation only around an axis that lies in that plane. Set to&quot;</span>
                <span class="s2">&quot;None to refine the in two orthogonal directions.&quot;</span>
        <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Fix goniometer parameters&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">fix_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Fix specified parameters by a list of 0-based indices or&quot;</span>
                <span class="s2">&quot;partial names to match&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">strings</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">constraints</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameter equal shift constraints to use in refinement.&quot;</span>
        <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="p">{</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Select only the specified experiments when looking up which&quot;</span>
                  <span class="s2">&quot;parameterisations to apply the constraint to. If an&quot;</span>
                  <span class="s2">&quot;identified parameterisation affects multiple experiments&quot;</span>
                  <span class="s2">&quot;then the index of any one of those experiments suffices to&quot;</span>
                  <span class="s2">&quot;identify that parameterisation. If None (the default) then&quot;</span>
                  <span class="s2">&quot;constraints will be applied to all parameterisations of&quot;</span>
                  <span class="s2">&quot;this type.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ints</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Identify which parameter of each parameterisation to&quot;</span>
                  <span class="s2">&quot;constrain by a (partial) parameter name to match. Model&quot;</span>
                  <span class="s2">&quot;name prefixes such as &#39;Detector1&#39; will be ignored as&quot;</span>
                  <span class="s2">&quot;parameterisations are already identified by experiment id&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
      <span class="p">}</span>
      <span class="n">force_static</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Force a static parameterisation for the goniometer when doing&quot;</span>
                <span class="s2">&quot;scan-varying refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">smoother</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options that affect scan-varying parameterisation&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">interval_width_degrees</span> <span class="o">=</span> <span class="mf">36.0</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Width of scan between checkpoints in degrees. Can be set to&quot;</span>
                  <span class="s2">&quot;Auto.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">absolute_num_intervals</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of intervals between checkpoints if scan_varying&quot;</span>
                  <span class="s2">&quot;refinement is requested. If set, this overrides&quot;</span>
                  <span class="s2">&quot;interval_width_degrees&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sparse</span> <span class="o">=</span> <span class="n">Auto</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Calculate gradients using sparse data structures.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">treat_single_image_as_still</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Set this to True to treat a single image scan with a non zero&quot;</span>
              <span class="s2">&quot;oscillation width as a still&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">spherical_relp_model</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;For stills refinement, set true to use the spherical relp model&quot;</span>
              <span class="s2">&quot;for prediction and gradients.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  <span class="n">refinery</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters to configure the refinery&quot;</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">{</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">SimpleLBFGS</span> <span class="n">LBFGScurvs</span> <span class="n">GaussNewton</span> <span class="n">LevMar</span> <span class="o">*</span><span class="n">SparseLevMar</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The minimisation engine to use&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
    <span class="n">max_iterations</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Maximum number of iterations in refinement before termination.&quot;</span>
              <span class="s2">&quot;None implies the engine supplies its own default.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Filename for an optional log that a minimisation engine may use&quot;</span>
              <span class="s2">&quot;to write additional information&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">path</span>
    <span class="n">journal</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Extra items to track in the refinement history&quot;</span>
    <span class="p">{</span>
      <span class="n">track_step</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record parameter shifts history in the refinement journal, if&quot;</span>
                <span class="s2">&quot;the engine supports it.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_gradient</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record parameter gradients history in the refinement journal,&quot;</span>
                <span class="s2">&quot;if the engine supports it.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_parameter_correlation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record correlation matrix between columns of the Jacobian for&quot;</span>
                <span class="s2">&quot;each step of refinement.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_jacobian_structure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record numbers of explicit and structural zeroes in each&quot;</span>
                <span class="s2">&quot;column of the Jacobian at each step of refinement.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_condition_number</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record condition number of the Jacobian for each step of &quot;</span>
                <span class="s2">&quot;refinement.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_normal_matrix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record the full normal matrix at each step of refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
      <span class="n">track_out_of_sample_rmsd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Record RMSDs calculated using the refined experiments with&quot;</span>
                <span class="s2">&quot;reflections not used in refinement at each step. Only valid&quot;</span>
                <span class="s2">&quot;if a subset of input reflections was taken for refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">target</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters to configure the target function&quot;</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">{</span>
    <span class="n">rmsd_cutoff</span> <span class="o">=</span> <span class="o">*</span><span class="n">fraction_of_bin_size</span> <span class="n">absolute</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Method to choose rmsd cutoffs. This is currently either as a&quot;</span>
              <span class="s2">&quot;fraction of the discrete units of the spot positional data,&quot;</span>
              <span class="s2">&quot;i.e. (pixel width, pixel height, image thickness in phi), or a&quot;</span>
              <span class="s2">&quot;tuple of absolute values to use as the cutoffs&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
    <span class="n">bin_size_fraction</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Set this to a fractional value, say 0.2, to make a cut off in&quot;</span>
              <span class="s2">&quot;the natural discrete units of positional data, viz., (pixel&quot;</span>
              <span class="s2">&quot;width, pixel height, image thickness in phi). This would then&quot;</span>
              <span class="s2">&quot;determine when the RMSD target is achieved. Only used if&quot;</span>
              <span class="s2">&quot;rmsd_cutoff = fraction_of_bin_size.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">absolute_cutoffs</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Absolute Values for the RMSD target achieved cutoffs in X, Y&quot;</span>
              <span class="s2">&quot;and Phi. The units are (mm, mm, rad).&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gradient_calculation_blocksize</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Maximum number of reflections to use for gradient calculation.&quot;</span>
              <span class="s2">&quot;If there are more reflections than this in the manager then the&quot;</span>
              <span class="s2">&quot;minimiser must do the full calculation in blocks.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">reflections</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters used by the reflection manager&quot;</span>
  <span class="p">{</span>
    <span class="n">reflections_per_degree</span> <span class="o">=</span> <span class="n">Auto</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The number of centroids per degree of the sequence to use in&quot;</span>
              <span class="s2">&quot;refinement. The default (Auto) uses all reflections unless the&quot;</span>
              <span class="s2">&quot;dataset is wider than a single turn. Then the number of&quot;</span>
              <span class="s2">&quot;reflections may be reduced until a minimum of 100 per degree of&quot;</span>
              <span class="s2">&quot;the sequence is reached to speed up calculations. Set this to&quot;</span>
              <span class="s2">&quot;None to force use all of suitable reflections.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">minimum_sample_size</span> <span class="o">=</span> <span class="mi">1000</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;cutoff that determines whether subsetting of the input&quot;</span>
              <span class="s2">&quot;reflection list is done&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">maximum_sample_size</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The maximum number of reflections to use in refinement.&quot;</span>
              <span class="s2">&quot;Overrides reflections_per_degree if that produces a larger&quot;</span>
              <span class="s2">&quot;sample size.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Random seed to use when sampling to create a working set of&quot;</span>
              <span class="s2">&quot;reflections. May be int or None.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">close_to_spindle_cutoff</span> <span class="o">=</span> <span class="mf">0.02</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The inclusion criterion currently uses the volume of the&quot;</span>
              <span class="s2">&quot;parallelepiped formed by the spindle axis, the incident beam&quot;</span>
              <span class="s2">&quot;and the scattered beam. If this is lower than some value then&quot;</span>
              <span class="s2">&quot;the reflection is excluded from refinement. In detector space,&quot;</span>
              <span class="s2">&quot;these are the reflections located close to the rotation axis.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">scan_margin</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Reflections within this value in degrees from the centre of the&quot;</span>
              <span class="s2">&quot;first or last image of the scan will be removed before&quot;</span>
              <span class="s2">&quot;refinement, unless doing so would result in too few remaining&quot;</span>
              <span class="s2">&quot;reflections. Reflections that are truncated at the scan edges&quot;</span>
              <span class="s2">&quot;have poorly-determined centroids and can bias the refined model&quot;</span>
              <span class="s2">&quot;if they are included.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">weighting_strategy</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Parameters to configure weighting strategy overrides&quot;</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">{</span>
      <span class="n">override</span> <span class="o">=</span> <span class="n">statistical</span> <span class="o">*</span><span class="n">stills</span> <span class="n">constant</span> <span class="n">external_deltapsi</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;selection of a strategy to override default weighting&quot;</span>
                <span class="s2">&quot;behaviour&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
      <span class="n">delpsi_constant</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;used by the stills strategy to choose absolute weight value&quot;</span>
                <span class="s2">&quot;for the angular distance from Ewald sphere term of the target&quot;</span>
                <span class="s2">&quot;function, whilst the X and Y parts use statistical weights&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">constants</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="mf">1.0</span> <span class="mf">1.0</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;constant weights for three parts of the target function,&quot;</span>
                <span class="s2">&quot;whether the case is for stills or scans. The default gives&quot;</span>
                <span class="s2">&quot;unit weighting.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">wavelength_weight</span> <span class="o">=</span> <span class="mf">1e4</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Weight for the wavelength term in the target function for&quot;</span>
                <span class="s2">&quot;Laue refinement&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">outlier</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Outlier rejection after initial reflection prediction.&quot;</span>
    <span class="p">{</span>
      <span class="n">algorithm</span> <span class="o">=</span> <span class="n">null</span> <span class="n">auto</span> <span class="o">*</span><span class="n">mcd</span> <span class="n">tukey</span> <span class="n">sauter_poon</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Outlier rejection algorithm. If auto is selected, the&quot;</span>
                <span class="s2">&quot;algorithm is chosen automatically.&quot;</span>
        <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="s2">&quot;Outlier rejection algorithm&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
      <span class="n">nproc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of processes over which to split outlier&quot;</span>
                <span class="s2">&quot;identification. If set to Auto, DIALS will choose&quot;</span>
                <span class="s2">&quot;automatically.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">minimum_number_of_reflections</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The minimum number of input observations per outlier&quot;</span>
                <span class="s2">&quot;rejection job below which all reflections in the job will be&quot;</span>
                <span class="s2">&quot;rejected as potential outliers.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">separate_experiments</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If true, outlier rejection will be performed on each&quot;</span>
                <span class="s2">&quot;experiment separately. Otherwise, the data from all&quot;</span>
                <span class="s2">&quot;experiments will be combined for outlier rejection.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">separate_panels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Perform outlier rejection separately for each panel of a&quot;</span>
                <span class="s2">&quot;multi- panel detector model. Otherwise data from across all&quot;</span>
                <span class="s2">&quot;panels will be combined for outlier rejection.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">separate_blocks</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If true, for scans outlier rejection will be performed&quot;</span>
                <span class="s2">&quot;separately in equal-width blocks of phi, controlled by the&quot;</span>
                <span class="s2">&quot;parameter outlier.block_width.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">block_width</span> <span class="o">=</span> <span class="n">Auto</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If separate_blocks, a scan will be divided into equal-sized&quot;</span>
                <span class="s2">&quot;blocks with width (in degrees) close to this value for&quot;</span>
                <span class="s2">&quot;outlier rejection. If Auto, a width of at least 18 degrees&quot;</span>
                <span class="s2">&quot;will be determined, such that each block contains enough&quot;</span>
                <span class="s2">&quot;reflections to perform outlier rejection.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">separate_images</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If true, every image will be treated separately for outlier&quot;</span>
                <span class="s2">&quot;rejection. It is a special case that will override both&quot;</span>
                <span class="s2">&quot;separate_experiments and separate_blocks, and will set these&quot;</span>
                <span class="s2">&quot;to False if required.&quot;</span>
        <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">tukey</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options for the tukey outlier rejector&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">iqr_multiplier</span> <span class="o">=</span> <span class="mf">1.5</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The IQR multiplier used to detect outliers. A value of 1.5&quot;</span>
                  <span class="s2">&quot;gives Tukey&#39;s rule for outlier detection&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">mcd</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options for the mcd outlier rejector, which uses an algorithm&quot;</span>
                <span class="s2">&quot;based on FAST-MCD by Rousseeuw and van Driessen. See&quot;</span>
                <span class="s2">&quot;doi.org/10.1080/00401706.1999.10485670.&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Decimal fraction controlling the size of subsets over which&quot;</span>
                  <span class="s2">&quot;the covariance matrix determinant is minimised.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_n_groups</span> <span class="o">=</span> <span class="mi">5</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The maximum number of groups to split the dataset into if&quot;</span>
                  <span class="s2">&quot;the dataset is &#39;large&#39; (more observations than twice the&quot;</span>
                  <span class="s2">&quot;min_group_size).&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">min_group_size</span> <span class="o">=</span> <span class="mi">300</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The smallest sub-dataset size when splitting the dataset&quot;</span>
                  <span class="s2">&quot;into a number of groups, maximally max_n_groups.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="mi">500</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The number of samples used for initial estimates to seed&quot;</span>
                  <span class="s2">&quot;the search within each sub-dataset.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="mi">2</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;The number of concentration steps to take after initial&quot;</span>
                  <span class="s2">&quot;estimates.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="mi">2</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If the dataset is &#39;large&#39;, the number of concentration&quot;</span>
                  <span class="s2">&quot;steps to take after applying the best subset estimates to&quot;</span>
                  <span class="s2">&quot;the merged group.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="mi">100</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;If the dataset is &#39;small&#39;, the number of concentration&quot;</span>
                  <span class="s2">&quot;steps to take after selecting the best of the initial&quot;</span>
                  <span class="s2">&quot;estimates, applied to the whole dataset.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">threshold_probability</span> <span class="o">=</span> <span class="mf">0.975</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Quantile probability from the Chi-squared distribution with&quot;</span>
                  <span class="s2">&quot;number of degrees of freedom equal to the number of&quot;</span>
                  <span class="s2">&quot;dimensions of the data data (e.g. 3 for X, Y and Phi&quot;</span>
                  <span class="s2">&quot;residuals). Observations whose robust Mahalanobis distances&quot;</span>
                  <span class="s2">&quot;are larger than the obtained quantile will be flagged as&quot;</span>
                  <span class="s2">&quot;outliers.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">sauter_poon</span>
        <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Options for the outlier rejector described in Sauter &amp; Poon&quot;</span>
                <span class="s2">&quot;(2010) (https://doi.org/10.1107/S0021889810010782)&quot;</span>
        <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">{</span>
        <span class="n">px_sz</span> <span class="o">=</span> <span class="n">Auto</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;X, Y pixel size in mm. If Auto, this will be taken from the&quot;</span>
                  <span class="s2">&quot;first panel of the first experiment.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">floats</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Verbose output.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">bool</span>
          <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Output file name for making graphs of |dr| vs spot number&quot;</span>
                  <span class="s2">&quot;and dy vs dx.&quot;</span>
          <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
          <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">nproc</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Number of parallel processes to run&quot;</span>
  <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">laue_dials</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributions &amp; Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/notebooks.html">Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/notebooks.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="functions.html">Command-Line Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="version.html">laue_dials.version</a></li>
<li class="toctree-l2"><a class="reference internal" href="find_spots.html">laue_dials.find_spots</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html">laue_dials.index</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequence_to_stills.html">laue_dials.sequence_to_stills</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimize_indexing.html">laue_dials.optimize_indexing</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">laue_dials.refine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-parameters">Basic parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#full-parameter-definitions">Full parameter definitions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="predict.html">laue_dials.predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="integrate.html">laue_dials.integrate</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_wavelengths.html">laue_dials.plot_wavelengths</a></li>
<li class="toctree-l2"><a class="reference internal" href="compute_rmsds.html">laue_dials.compute_rmsds</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">Full API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/tutorials.html">Jupyter Tutorials</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="functions.html">Functions</a><ul>
      <li>Previous: <a href="optimize_indexing.html" title="previous chapter">laue_dials.optimize_indexing</a></li>
      <li>Next: <a href="predict.html" title="next chapter">laue_dials.predict</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Rick Hewitt.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/cli/refine.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
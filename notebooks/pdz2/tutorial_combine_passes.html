<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Installation &#8212; laue-dials</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=0ca6144b" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=bb2e3f7c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="icon" href="../../_static/rs-favicon_32x32.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="tutorials" href="pdz2.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="Installation">
<h1>Installation<a class="headerlink" href="#Installation" title="Link to this heading"></a></h1>
<p>The easiest way to install <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> and its dependencies is using <a class="reference external" href="https://docs.anaconda.com/free/anaconda/install/index.html">Anaconda</a>. First we update and install the libmamba solver with</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conda update -n base conda
conda install -n base conda-libmamba-solver
conda config --set solver libmamba
</pre></div>
</div>
<p>With Anaconda, we can then create and activate a custom environment for your install by running</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conda create --name laue-dials
conda activate laue-dials
</pre></div>
</div>
<p>Now we are ready to install the main dependency and framework: <a class="reference external" href="https://dials.github.io">DIALS</a>. After installing that, we can install <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> using pip, as below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conda install -c conda-forge dials
pip install laue-dials
</pre></div>
</div>
<p>All other dependencies will then be automatically installed for us, and we’ll be ready to analyze your first Laue data set! Reopen this notebook with the appropriate environment activated when ready.</p>
<p>Documentation for <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> can be found at <a class="reference external" href="https://rs-station.github.io/laue-dials/index.html">here</a>, and entering a command with no arguments on the command line will also print a help page!</p>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Link to this heading"></a></h2>
<p>In this notebook, we will process a time-resolved EF-X dataset.</p>
<p>The data is comprised of four passes of four timepoints each. Each of the four electric-field timepoints is taken for a given <code class="docutils literal notranslate"><span class="pre">phi</span></code> angle, then the crystal is rotated aaround the phi goniometer axis and then the four timepoints are taken again. This is done over four passes, <code class="docutils literal notranslate"><span class="pre">c,d,e,f</span></code>. The start angle and the step can be found in the below table.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>pass</p></th>
<th class="head"><p>start phi angle (deg)</p></th>
<th class="head"><p>rotation phi step (deg)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>c</p></td>
<td><p>0</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>d</p></td>
<td><p>92</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>e</p></td>
<td><p>181</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>f</p></td>
<td><p>361.5</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>At the end of processing, we would like four <code class="docutils literal notranslate"><span class="pre">.mtz</span></code> files, one for each timepoint. We must run <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> on each timepoint individually, then combine all passes for a given timepoint at the end. We start with the <code class="docutils literal notranslate"><span class="pre">off</span></code> timepoint pass <code class="docutils literal notranslate"><span class="pre">c</span></code> only. Then, we will analyze all sixteen passes in a single script, and combine the output mtzs into a single mtz file.</p>
<p>Data processing will rely on images found in <code class="docutils literal notranslate"><span class="pre">./images</span></code> and scripts found in <code class="docutils literal notranslate"><span class="pre">./scripts</span></code>.</p>
</section>
<section id="Importing-Data">
<h2>Importing Data<a class="headerlink" href="#Importing-Data" title="Link to this heading"></a></h2>
<p>We can use <code class="docutils literal notranslate"><span class="pre">dials.import</span></code> as a way to import the data files written at experimental facilities into a format that is friendly to both <code class="docutils literal notranslate"><span class="pre">DIALS</span></code> and <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code>. Feel free to use any data set you’d like below, but a <a class="reference external" href="https://zenodo.org/record/6407157">sample time-resolved EF-X data set</a> has been uploaded to Zenodo for your convenience, and this notebook has been tested using that dataset.</p>
<p>First, we create two dictionaries, <code class="docutils literal notranslate"><span class="pre">START_ANGLES</span></code> and <code class="docutils literal notranslate"><span class="pre">OSCS</span></code>, that respectively map the pass names to the start angles and rotation steps (treated as oscillations in <code class="docutils literal notranslate"><span class="pre">dials.import)</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>declare -A START_ANGLES=( [&quot;c&quot;]=0 [&quot;d&quot;]=92 [&quot;e&quot;]=181 [&quot;f&quot;]=361.5)
declare -A OSCS=( [&quot;c&quot;]=2 [&quot;d&quot;]=2 [&quot;e&quot;]=2 [&quot;f&quot;]=1)
</pre></div>
</div>
<p>Then, we import the files for the <code class="docutils literal notranslate"><span class="pre">c</span></code>,<code class="docutils literal notranslate"><span class="pre">off</span></code> images using <code class="docutils literal notranslate"><span class="pre">dials.import</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="c1">#these start-angles and sweep angles are to be manually input by the user using information from their particular experimental design.</span>
<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">START_ANGLES</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">92</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">181</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">361.5</span><span class="p">)</span>
<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">OSCS</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#this is the delay time.</span>
<span class="n">TIME</span><span class="o">=</span><span class="s2">&quot;off&quot;</span>
<span class="c1"># this is the pass.</span>
<span class="k">pass</span><span class="o">=</span><span class="s2">&quot;c&quot;</span>
<span class="n">FILE_INPUT_TEMPLATE</span><span class="o">=</span><span class="s2">&quot;data/e35$</span><span class="si">{pass}</span><span class="s2">_$</span><span class="si">{TIME}</span><span class="s2">_###.mccd&quot;</span>
<span class="c1"># Import data into DIALS files</span>
<span class="n">dials</span><span class="o">.</span><span class="kn">import</span><span class="w"> </span><span class="nn">geometry.scan.oscillation</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">START_ANGLES</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]},</span><span class="err">$</span><span class="p">{</span><span class="n">OSCS</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span>\
    <span class="n">geometry</span><span class="o">.</span><span class="n">goniometer</span><span class="o">.</span><span class="n">invert_rotation_axis</span><span class="o">=</span><span class="kc">True</span> \
    <span class="n">geometry</span><span class="o">.</span><span class="n">goniometer</span><span class="o">.</span><span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span> \
    <span class="n">geometry</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">wavelength</span><span class="o">=</span><span class="mf">1.04</span> \
    <span class="n">geometry</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="o">=</span><span class="mf">0.08854</span><span class="p">,</span><span class="mf">0.08854</span> \
    <span class="nb">input</span><span class="o">.</span><span class="n">template</span><span class="o">=</span><span class="err">$</span><span class="n">FILE_INPUT_TEMPLATE</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">experiments</span><span class="o">=</span><span class="n">imported</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
</div>
</section>
<section id="Getting-an-Initial-Estimate">
<h2>Getting an Initial Estimate<a class="headerlink" href="#Getting-an-Initial-Estimate" title="Link to this heading"></a></h2>
<p>After importing our data, the first thing we need to do is get an initial estimate for the experimental geometry. Here, we’ll use some monochromatic algorithms from DIALS to help! This step can be tricky – failure can be due to several causes. In the event of failure, here are a few common causes:</p>
<ol class="arabic simple">
<li><p>The spotfinding gain is either too high or too low. Try looking at the results of <code class="docutils literal notranslate"><span class="pre">dials.image_viewer</span> <span class="pre">imported.expt</span> <span class="pre">strong.refl</span></code> and seeing if you have too many (or too few) reflections. Lower gain gives you more spots, but also more likely to give false positives.</p></li>
<li><p>Supplying the space group or unit cell during indexing can be helpful. When supplying the unit cell, allow for some variation in the lengths of the axes, since the monochromatic algorithms may result in a slightly scaled unit cell depending on the chosen wavelength.</p></li>
<li><p>You may have intensities that need to be masked. These can come from bad panels or extraneous scatter. You can use <code class="docutils literal notranslate"><span class="pre">dials.image_viewer</span></code> (described below) to create a mask file for your data, and then provide the <code class="docutils literal notranslate"><span class="pre">spotfinder.lookup.mask=&quot;pixels.mask&quot;</span></code> command below to use that mask during spotfinding.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">laue</span><span class="o">.</span><span class="n">find_spots</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span> \
    <span class="n">spotfinder</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">nproc</span><span class="o">=</span><span class="mi">8</span> \
    <span class="n">spotfinder</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">dispersion</span><span class="o">.</span><span class="n">gain</span><span class="o">=</span><span class="mf">0.3</span> \
    <span class="n">spotfinder</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">max_separation</span><span class="o">=</span><span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">CELL</span><span class="o">=</span><span class="s1">&#39;&quot;65.3,39.45,39.01,90.000,117.45,90.000&quot;&#39;</span> <span class="c1">#this is a unit cell of PDZ2 from PDB 5E11</span>

<span class="n">laue</span><span class="o">.</span><span class="n">index</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span> <span class="n">strong</span><span class="o">.</span><span class="n">refl</span> \
    <span class="n">indexer</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span><span class="o">=</span><span class="mi">5</span> \
    <span class="n">indexer</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">refine_shells</span> \
    <span class="n">indexer</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">=</span><span class="err">$</span><span class="n">CELL</span> \
    <span class="n">indexer</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">parameterisation</span><span class="o">.</span><span class="n">auto_reduction</span><span class="o">.</span><span class="n">action</span><span class="o">=</span><span class="n">fix</span> \
    <span class="n">laue_output</span><span class="o">.</span><span class="n">index_only</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
</div>
</section>
<section id="Viewing-Images">
<h2>Viewing Images<a class="headerlink" href="#Viewing-Images" title="Link to this heading"></a></h2>
<p>Sometimes it’s helpful to be able to see the analysis data overlayed on the raw data. DIALS has a utility for viewing spot information on the raw images called <code class="docutils literal notranslate"><span class="pre">dials.image_viewer</span></code>. For example, the spotfinding gain parameter can be tuned to capture more spots, but lowering it too much finds nonexistent spots. To check this, we can use the image viewer to see what spots were found on images. We need to provide an <code class="docutils literal notranslate"><span class="pre">expt</span></code> file and a <code class="docutils literal notranslate"><span class="pre">refl</span></code> file – the <code class="docutils literal notranslate"><span class="pre">imported.expt</span></code> and <code class="docutils literal notranslate"><span class="pre">strong.refl</span></code>
files will do for checking spotfinding. This program also has utilities for generating masks if they are needed. The red dots from the checkbox “Mark centers of mass” are the spots found by <code class="docutils literal notranslate"><span class="pre">laue.find_spots</span></code> (which in turn makes a call to <code class="docutils literal notranslate"><span class="pre">dials.find_spots</span></code>). These are best used for judging whether you need to adjust the gain higher (for fewer spots) or lower (for more) during spotfinding. You can find more details on the image viewer in the <a class="reference external" href="https://dials.github.io/documentation/tutorials/processing_in_detail_betalactamase.html">DIALS tutorial
here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">dials</span><span class="o">.</span><span class="n">image_viewer</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span> <span class="n">strong</span><span class="o">.</span><span class="n">refl</span>
</pre></div>
</div>
</div>
</section>
<section id="Making-Stills">
<h2>Making Stills<a class="headerlink" href="#Making-Stills" title="Link to this heading"></a></h2>
<p>Here we will now split our monochromatic estimate into a series of stills to prepare it for the polychromatic pipeline. There is a useful utility called <code class="docutils literal notranslate"><span class="pre">laue.sequence_to_stills</span></code> for this.</p>
<p>NOTE: Do not use <code class="docutils literal notranslate"><span class="pre">dials.sequence_to_stills</span></code>, as there are data columns which do not match between the two programs.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">laue</span><span class="o">.</span><span class="n">sequence_to_stills</span> <span class="n">monochromatic</span><span class="o">.*</span>
<span class="c1">#cctbx.python scripts/sequence_to_stills-newest_ld.py monochromatic.*</span>
</pre></div>
</div>
</div>
</section>
<section id="Polychromatic-Analysis">
<h2>Polychromatic Analysis<a class="headerlink" href="#Polychromatic-Analysis" title="Link to this heading"></a></h2>
<p>Here we will use four other programs in <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> to create a polychromatic experimental geometry using our initial monochromatic estimate. Each of the programs does the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.optimize_indexing</span></code> assigns wavelengths to reflections and refines the crystal orientation jointly.</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.refine</span></code> is a polychromatic wrapper for <code class="docutils literal notranslate"><span class="pre">dials.refine</span></code> and allows for refining the experimental geometry overall to one suitable for spot prediction and integration.</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.predict</span></code> takes the refined experimental geometry and predicts the centroids of all strong and weak reflections on the detector.</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.integrate</span></code> then builds spot profiles and integrates intensities on the detector.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">N</span><span class="o">=</span><span class="mi">8</span> <span class="c1"># Max multiprocessing</span>
<span class="n">laue</span><span class="o">.</span><span class="n">optimize_indexing</span> <span class="n">stills</span><span class="o">.*</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">experiments</span><span class="o">=</span><span class="s2">&quot;optimized.expt&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">reflections</span><span class="o">=</span><span class="s2">&quot;optimized.refl&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">log</span><span class="o">=</span><span class="s2">&quot;laue.optimize_indexing.log&quot;</span> \
    <span class="n">wavelengths</span><span class="o">.</span><span class="n">lam_min</span><span class="o">=</span><span class="mf">0.95</span> \
    <span class="n">wavelengths</span><span class="o">.</span><span class="n">lam_max</span><span class="o">=</span><span class="mf">1.2</span> \
    <span class="n">reciprocal_grid</span><span class="o">.</span><span class="n">d_min</span><span class="o">=</span><span class="mf">1.7</span> \
    <span class="n">nproc</span><span class="o">=</span><span class="err">$</span><span class="n">N</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">N</span><span class="o">=</span><span class="mi">8</span> <span class="c1"># Max multiprocessing</span>
<span class="n">laue</span><span class="o">.</span><span class="n">refine</span> <span class="n">optimized</span><span class="o">.*</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">experiments</span><span class="o">=</span><span class="s2">&quot;poly_refined.expt&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">reflections</span><span class="o">=</span><span class="s2">&quot;poly_refined.refl&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">log</span><span class="o">=</span><span class="s2">&quot;laue.poly_refined.log&quot;</span> \
    <span class="n">nproc</span><span class="o">=</span><span class="err">$</span><span class="n">N</span> <span class="o">&gt;&gt;</span> <span class="n">sink</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</div>
<p>To check the refinement quality, we check the spotfinding root-mean-square deviations (rmsds) as a function of image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
laue.compute_rmsds<span class="w"> </span>poly_refined.*<span class="w"> </span><span class="nv">refined_only</span><span class="o">=</span>True
</pre></div>
</div>
</div>
<p>These <code class="docutils literal notranslate"><span class="pre">rmsd</span></code>s look good.</p>
</section>
</section>
<section id="Checking-the-Wavelength-Spectrum">
<h1>Checking the Wavelength Spectrum<a class="headerlink" href="#Checking-the-Wavelength-Spectrum" title="Link to this heading"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">laue.plot_wavelengths</span></code> allows us to plot the wavelengths assigned in stored in a reflection table. The histogram of these reflections should resemble the beam spectrum, so this is a good check to do at this time!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">laue</span><span class="o">.</span><span class="n">plot_wavelengths</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">refl</span> <span class="n">refined_only</span><span class="o">=</span><span class="kc">True</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;wavelengths.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This is the expected wavelength profile, indicating successful wavelength assignment.</p>
</section>
<section id="DIALS-Reports">
<h1>DIALS Reports<a class="headerlink" href="#DIALS-Reports" title="Link to this heading"></a></h1>
<p>DIALS has a utility that gives useful information on various diagnostics you may be interested in while analyzing your data. The program <code class="docutils literal notranslate"><span class="pre">dials.report</span></code> generates an HTML file you can open to see information and plots regarding the status of your analyzed data. You can run it on any files generated by <code class="docutils literal notranslate"><span class="pre">DIALS</span></code> or <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">dials</span><span class="o">.</span><span class="n">report</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">expt</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">refl</span>
</pre></div>
</div>
</div>
<section id="Integrating-Spots">
<h2>Integrating Spots<a class="headerlink" href="#Integrating-Spots" title="Link to this heading"></a></h2>
<p>Now that we have a refined experiment model, we can use <code class="docutils literal notranslate"><span class="pre">laue.predict</span></code> and <code class="docutils literal notranslate"><span class="pre">laue.integrate</span></code> to get integrated intensities from the data. We will predict the locations of all feasible spots on the detector given our refined experiment model, and at each of those locations we will integrate the intensities to get an <code class="docutils literal notranslate"><span class="pre">mtz</span></code> file that we can feed into <code class="docutils literal notranslate"><span class="pre">careless</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">N</span><span class="o">=</span><span class="mi">8</span> <span class="c1"># Max multiprocessing</span>
<span class="n">laue</span><span class="o">.</span><span class="n">predict</span> <span class="n">poly_refined</span><span class="o">.*</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">reflections</span><span class="o">=</span><span class="s2">&quot;predicted.refl&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">log</span><span class="o">=</span><span class="s2">&quot;laue.predict.log&quot;</span> \
    <span class="n">wavelengths</span><span class="o">.</span><span class="n">lam_min</span><span class="o">=</span><span class="mf">0.95</span> \
    <span class="n">wavelengths</span><span class="o">.</span><span class="n">lam_max</span><span class="o">=</span><span class="mf">1.2</span> \
    <span class="n">reciprocal_grid</span><span class="o">.</span><span class="n">d_min</span><span class="o">=</span><span class="mf">1.7</span> \
    <span class="n">nproc</span><span class="o">=</span><span class="err">$</span><span class="n">N</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">N</span><span class="o">=</span><span class="mi">8</span> <span class="c1"># Max multiprocessing</span>
<span class="n">laue</span><span class="o">.</span><span class="n">integrate</span> <span class="n">poly_refined</span><span class="o">.</span><span class="n">expt</span> <span class="n">predicted</span><span class="o">.</span><span class="n">refl</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;integrated.mtz&quot;</span> \
    <span class="n">output</span><span class="o">.</span><span class="n">log</span><span class="o">=</span><span class="s2">&quot;laue.integrate.log&quot;</span> \
    <span class="n">nproc</span><span class="o">=</span><span class="err">$</span><span class="n">N</span>
</pre></div>
</div>
</div>
</section>
<section id="Processing-and-Combining-All-Passes">
<h2>Processing and Combining All Passes<a class="headerlink" href="#Processing-and-Combining-All-Passes" title="Link to this heading"></a></h2>
<p>We have successfully integrated one of the sixteen image series. Let’s now process the rest. For the <code class="docutils literal notranslate"><span class="pre">off</span></code> timepoints, we process as above. Pass <code class="docutils literal notranslate"><span class="pre">e</span></code> has a different indexing solution (up to the C2 symmetry operation <code class="docutils literal notranslate"><span class="pre">-x,y,-z</span></code>) and so we reindex pass <code class="docutils literal notranslate"><span class="pre">e</span></code> using <a class="reference external" href="https://dials.github.io/documentation/programs/dials_reindex.html">dials.reindex</a>.</p>
<p>Our strategy for the <code class="docutils literal notranslate"><span class="pre">50ns</span></code>,<code class="docutils literal notranslate"><span class="pre">100ns</span></code>,<code class="docutils literal notranslate"><span class="pre">200ns</span></code> timepoints is to transfer the <code class="docutils literal notranslate"><span class="pre">stills.expt</span></code> geometry and then refine spot positions that may have changed due to the electric field.</p>
<p>Using the attached <code class="docutils literal notranslate"><span class="pre">../scripts/one-pass-from_off.sh</span></code> script which contains all of the above <code class="docutils literal notranslate"><span class="pre">bash</span></code> code, we iterate over all of the passes in the below cell. The below cell takes a while to run – we don’t recommend to run this in the jupyter notebook. Instead, we recommend to run it as a standalone parallel script, attached as <code class="docutils literal notranslate"><span class="pre">../scripts/process.sh</span></code>. Either proccedure will create a folder named <code class="docutils literal notranslate"><span class="pre">gain_0,3</span></code> containing subfolders of <code class="docutils literal notranslate"><span class="pre">dials</span></code> files for each pass. For example,
<code class="docutils literal notranslate"><span class="pre">../gain_0,3-from_stills/dials_files_d_100ns</span></code> contains <code class="docutils literal notranslate"><span class="pre">dials</span></code> files for pass <code class="docutils literal notranslate"><span class="pre">d</span></code>, timepoint <code class="docutils literal notranslate"><span class="pre">100ns</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">START_ANGLES</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">92</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">181</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">361.5</span><span class="p">)</span>
<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">OSCS</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">DELAY</span><span class="o">=</span><span class="s2">&quot;off&quot;</span>

<span class="n">gain</span><span class="o">=</span><span class="mf">0.3</span>
<span class="k">for</span> <span class="k">pass</span> <span class="ow">in</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span>
<span class="n">do</span>
    <span class="k">if</span> <span class="p">[</span> <span class="k">pass</span> <span class="o">==</span> <span class="n">e</span> <span class="p">];</span><span class="n">then</span>
        <span class="n">sh</span> <span class="n">scripts</span><span class="o">/</span><span class="n">one_pass</span><span class="o">-</span><span class="n">from_off</span><span class="o">.</span><span class="n">sh</span> <span class="err">$</span><span class="k">pass</span> <span class="err">$</span><span class="n">DELAY</span> <span class="err">$</span><span class="p">{</span><span class="n">START_ANGLES</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="p">{</span><span class="n">OSCS</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="n">gain</span> <span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="o">-</span><span class="n">z</span> <span class="o">&gt;&gt;</span> <span class="n">sink</span><span class="o">.</span><span class="n">log</span>
    <span class="k">else</span>
        <span class="n">sh</span> <span class="n">scripts</span><span class="o">/</span><span class="n">one_pass</span><span class="o">-</span><span class="n">from_off</span><span class="o">.</span><span class="n">sh</span> <span class="err">$</span><span class="k">pass</span> <span class="err">$</span><span class="n">DELAY</span> <span class="err">$</span><span class="p">{</span><span class="n">START_ANGLES</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="p">{</span><span class="n">OSCS</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="n">gain</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">&gt;&gt;</span> <span class="n">sink</span><span class="o">.</span><span class="n">log</span>
    <span class="n">fi</span>
<span class="n">done</span>
</pre></div>
</div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">off</span></code> timepoint series finish, we process the remaining timepoints.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">bash</span>

<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">START_ANGLES</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">92</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">181</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">361.5</span><span class="p">)</span>
<span class="n">declare</span> <span class="o">-</span><span class="n">A</span> <span class="n">OSCS</span><span class="o">=</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gain</span><span class="o">=</span><span class="mf">0.3</span>
<span class="k">for</span> <span class="n">delay</span> <span class="ow">in</span> <span class="s2">&quot;50ns&quot;</span> <span class="s2">&quot;100ns&quot;</span> <span class="s2">&quot;200ns&quot;</span>
<span class="n">do</span>
    <span class="k">for</span> <span class="k">pass</span> <span class="ow">in</span> <span class="s2">&quot;c&quot;</span> <span class="s2">&quot;d&quot;</span> <span class="s2">&quot;e&quot;</span> <span class="s2">&quot;f&quot;</span>
    <span class="n">do</span>
        <span class="n">sh</span> <span class="n">scripts</span><span class="o">/</span><span class="n">one_pass</span><span class="o">-</span><span class="n">from_off</span><span class="o">.</span><span class="n">sh</span> <span class="err">$</span><span class="k">pass</span> <span class="err">$</span><span class="n">delay</span> <span class="err">$</span><span class="p">{</span><span class="n">START_ANGLES</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="p">{</span><span class="n">OSCS</span><span class="p">[</span><span class="err">$</span><span class="k">pass</span><span class="p">]}</span> <span class="err">$</span><span class="n">gain</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">&gt;&gt;</span> <span class="n">sink</span><span class="o">.</span><span class="n">log</span>
    <span class="n">done</span>
<span class="n">done</span>
</pre></div>
</div>
</div>
<p>Finally, we combine all <code class="docutils literal notranslate"><span class="pre">.mtz</span></code> files for passes of a single timepoint using the attached <code class="docutils literal notranslate"><span class="pre">scripts/expt_concat.py</span></code> script. <code class="docutils literal notranslate"><span class="pre">.mtz</span></code> files can be found in <code class="docutils literal notranslate"><span class="pre">gain_0,3-from_stills/ld_0,3_mtzs</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
python<span class="w"> </span>scripts/expt_concat.py<span class="w"> </span><span class="m">0</span>.3
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">reciprocalspaceship</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rs</span>
<span class="n">rs</span><span class="o">.</span><span class="n">read_mtz</span><span class="p">(</span><span class="s2">&quot;gain_0,3/ld_0,3_mtzs/cdef_e35_off.mtz&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We expect a mtz file with about 350,000 reflections.</p>
</section>
<section id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Link to this heading"></a></h2>
<p>At this point, you now have integrated <code class="docutils literal notranslate"><span class="pre">mtz</span></code> files that you can pass to <a class="reference external" href="https://github.com/rs-station/careless">careless</a> for scaling and merging. We provide an example <code class="docutils literal notranslate"><span class="pre">careless</span></code> script, found at <code class="docutils literal notranslate"><span class="pre">../scripts/careless-cdef-ohp-mlpw.sh</span></code>. However, after all Laue-DIALS files are printed out, <code class="docutils literal notranslate"><span class="pre">../scripts/reduce.sh</span></code> can also be run for a complete analysis.</p>
<p>Note that throughout this pipeline, you can use DIALS utilities like <code class="docutils literal notranslate"><span class="pre">dials.image_viewer</span></code> or <code class="docutils literal notranslate"><span class="pre">dials.report</span></code> to check progress and ensure your data is being analyzed properly. We recommend regularly checking the analysis by looking at the data on images, which can be done by</p>
<p><code class="docutils literal notranslate"><span class="pre">dials.image_viewer</span> <span class="pre">FILE.expt</span> <span class="pre">FILE.refl</span></code>.</p>
<p>These files are generally written as pairs with the same base name, with the exception of combining <code class="docutils literal notranslate"><span class="pre">imported.expt</span></code> + <code class="docutils literal notranslate"><span class="pre">strong.refl</span></code>, or <code class="docutils literal notranslate"><span class="pre">poly_refined.expt</span></code> + <code class="docutils literal notranslate"><span class="pre">predicted.refl</span></code>.</p>
<p>Also note that you can take any program and enter it on the command-line for further help. For example, writing</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.optimize_indexing</span></code></p>
<p>will print a help page for the program. You can see all configurable parameters by using</p>
<p><code class="docutils literal notranslate"><span class="pre">laue.optimize_indexing</span> <span class="pre">-c</span></code>.</p>
<p>This applies to all <code class="docutils literal notranslate"><span class="pre">laue-dials</span></code> command-line programs.</p>
<p>Congratulations! This tutorial is now over. For further questions, feel free to consult documentation or email the <a class="reference external" href="https://pypi.org/project/laue-dials/">authors</a>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">laue_dials</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributions &amp; Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/notebooks.html">Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/notebooks.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/functions.html">Command-Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Full API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Jupyter Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../hewl/hewl.html">Processing Anomalous Scattering with HEWL Data</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="pdz2.html">Time-Resolved EF-X Processing on PDZ2 Data</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Checking-the-Wavelength-Spectrum">Checking the Wavelength Spectrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="#DIALS-Reports">DIALS Reports</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../tutorials.html">tutorials</a><ul>
  <li><a href="pdz2.html">tutorials</a><ul>
      <li>Previous: <a href="pdz2.html" title="previous chapter">tutorials</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Rick Hewitt.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../../_sources/notebooks/pdz2/tutorial_combine_passes.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>